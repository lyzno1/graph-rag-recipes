# GraphRAG 菜谱技术方案报告

## 1. 背景与目标
- **项目定位**：以 HowToCook 菜谱为语料，构建融合图结构与 RAG（Retrieval-Augmented Generation）的智能推荐 Demo，支撑课程 Project-4「基于 GraphRAG 的推理」。
- **目标体验**：输入用户 ID（如 `U123`）或任意菜名，系统返回相似菜谱及可解释的中文推荐理由，可在 CLI/Streamlit 中展示。
- **交付范围**：提供数据准备脚本、图构建与检索逻辑、LLM 生成封装以及 CLI 入口，所有依赖通过 `uv sync` 管理。

## 2. 系统总体原理
```
用户输入 (UserID / 菜名)
      │
      ▼
数据层 → 图构建 → 图检索 → 语义检索 → LLM 生成 → 展示
```
- **数据层**：`HowToCookIngestor` 下载/解析 Markdown，生成结构化 `RecipeRecord`，并提供 `sample_recipes.json` 兜底数据。
- **图构建**：`RecipeGraphBuilder` 依据食材、标签重叠计算相似度 > 阈值即连边，得到无向加权图。
- **图检索**：`RecipeRetriever` 以邻域遍历获取 Top-N 相似菜谱，支持标题模糊匹配。
- **语义检索**：`RecipeEmbeddingIndex` 利用 `sentence-transformers` 维持向量索引，用于文本查询或图稀疏时的补充。
- **LLM 生成**：`LLMGenerator` 组合参考菜谱+候选菜谱生成 prompt，默认调用 OpenAI `gpt-4o-mini`，未提供 API Key 时回落到模板化理由。
- **展示层**：`ui_components.format_cli_block` 输出 CLI 文案，后续可复用到 Streamlit。

## 3. 数据来源与处理方式
| 目录 | 含义 | 说明 |
| --- | --- | --- |
| `data/raw/` | 原始 HowToCook 仓库或示例 | 通过 `scripts/bootstrap_data.py` 自动 clone / 拉取压缩包；仅保留 sample & README 入库。 |
| `data/processed/` | 结构化 JSON | `recipes_index.json`（大规模）+ `sample_recipes.json`（示例），均以 `RecipeRecord` 结构存储。 |
| `scripts/bootstrap_data.py` | 数据准备脚本 | 支持 `--force-repo`、`--force-processed`、`--limit`、`--skip-download`、`--strategy` 等参数，用于演示/调试。 |

解析流程亮点：
1. Markdown 章节通过多语言别名匹配 `ingredients/seasonings/instructions/tips`，兼容 HowToCook 不同格式。
2. `RecipeRecord.recipe_id` 由相对路径拼接，保证唯一性并可反查原文。
3. 若下载失败会生成 `DATASET_PLACEHOLDER.txt` 并回落到示例数据，确保离线/课堂演示稳定。

## 4. 模块分层与职责
| 层级 | 模块 | 关键功能 |
| --- | --- | --- |
| 配置 | `config.ProjectConfig` | 统一路径、模型、邻居数量、相似度阈值以及 LLM API Key 解析（自动从 `.env` 加载）。 |
| 数据 | `data_ingest.HowToCookIngestor` | 下载/解析/缓存菜谱，提供示例与 processed 迭代器。 |
| 图 | `graph_builder.RecipeGraphBuilder` | 添加节点属性，计算 0.6*Jaccard + 0.3*重叠率 + 0.1*标签 Jaccard 的相似度。 |
| 检索 | `retrieval.RecipeRetriever` | 基于边权排序邻居，亦可根据文本提前定位锚点。 |
| 向量 | `embeddings.RecipeEmbeddingIndex` | 可选的 sentence-transformers 编码器；若依赖缺失自动退化为停用状态。 |
| LLM | `llm_generator.LLMGenerator` | 构建 prompt + 调用 OpenAI Responses API，或输出食材重叠模板文本。 |
| 用户画像 | `user_profiles.UserProfileRepository` | 内置 `U123/U207/U305` 样本，包含历史菜谱与偏好标签。 |
| 管线 | `pipeline.GraphRAGPipeline` | 串联所有层：`bootstrap_graph()` → `recommend()` → 返回 `RecommendationResult`。 |
| 界面 | `ui_components` | 提供 CLI 格式化与 Streamlit 预备渲染。 |

## 5. 推荐链路拆解
1. **图构建启动**：`GraphRAGPipeline.bootstrap_graph()` 从 `HowToCookIngestor.iter_records()` 读取记录，构建 networkx 图并同步构建向量索引。
2. **入口解析**：`recommend()` 首先检测输入是否为用户 ID，命中 `UserProfileRepository` 则走“用户画像 → 多个参考菜谱 → 聚合邻域”路径。
3. **菜名检索**：若为文本，依次尝试：节点 ID 命中 → 标题模糊匹配 → 向量 Top-1，得到参考菜谱。
4. **候选生成**：优先图邻居；若无邻居则使用向量近邻；仍为空则 `_fallback_candidates()` 根据食材/标签重叠从样本中补齐。
5. **推荐解释**：`LLMGenerator.generate()` 将参考菜谱+候选菜谱 + 用户输入组合成 prompt 调用 OpenAI；无 Key 时生成解释模板。
6. **结果输出**：`RecommendationResult` 返回 `reference_recipe/similar_recipes/explanation`，`ui_components` 负责渲染。

## 6. 运行方式与依赖
1. **环境准备**
   - `uv sync`：安装 Python 3.11 虚拟环境与锁定依赖。
   - `cp .env.example .env` 并填写 `OPENAI_API_KEY`（或 `OLLAMA_API_KEY/ZHIPU_API_KEY`）。
2. **数据准备**
   ```bash
   uv run scripts/bootstrap_data.py \
     --limit 800 \
     --force-processed
   ```
   可用 `--skip-download` 在离线环境直接使用示例数据。
3. **体验推荐流程**
   ```bash
   uv run scripts/run_pipeline.py U123
   uv run scripts/run_pipeline.py "番茄炒蛋"
   uv run graph-rag-recipes "红烧肉"
   ```
4. **测试与调试**：`uv run pytest -q`（后续可配合 `-k graph_builder` 针对性验证）。

## 7. 交互及演示建议
- **CLI Demo**：直接复制命令行输出到 PPT，突出“参考菜谱 + 相似菜谱列表 + 推荐理由”。
- **Streamlit 方向**：`ui_components.streamlit_render()` 已返回可直接渲染的文本列表，只需在 Streamlit 页面中调用即可。
- **数据可视化**（可选）：networkx 图可导出为 `graphml` 或使用 `nx.draw` 生成截图展示“菜谱节点 + 食材标签”关系。

## 8. 风险与改进方向
1. **数据完整性**：依赖 HowToCook 仓库结构，若上游目录调整需更新 `EXCLUDED_DIR_PARTS` 和章节别名；可通过 `--limit` 控制规模。
2. **LLM 依赖**：OpenAI API Key 缺失时会使用模板理由，需提前说明；也可在 `ModelSettings` 中切换至自建 LLM。
3. **性能/扩展**：当前图构建为 O(N²) 组合，适合 demo 规模；若要扩展到万级需改用局部特征索引或分桶比较。
4. **评估指标**：目前以主观可解释性为主，可新增“用户点击率”“多样性”等指标并在报告中展示。

## 9. 关键配置与参数
| 配置 | 位置 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `ProjectPaths` | `config.py` | `data/raw`, `data/processed` | 统一路径管理，`ensure()` 会自动创建目录。 |
| `max_neighbors` | `ProjectConfig` | `10` | 控制图检索和向量检索返回的候选数量。 |
| `similarity_threshold` | `ProjectConfig` | `0.2` | `RecipeGraphBuilder` 建边阈值，可在不同数据规模下调优。 |
| `embedding_model` | `ModelSettings` | `sentence-transformers/all-MiniLM-L6-v2` | 控制向量索引使用的预训练模型，可改为本地模型避免联网下载。 |
| `llm_provider` / `llm_model` | `ModelSettings` | `openai` / `gpt-4o-mini` | 默认调用 OpenAI Responses API；可替换为 `ollama` 等自托管方案。 |
| `.env` 变量 | 项目根目录 | `OPENAI_API_KEY` 等 | 通过 `dotenv` 自动加载，所有 Secrets 使用环境变量传递，便于部署。 |

## 10. Demo 讲解节奏建议
1. **切入问题**：展示用户提出“想做番茄炒蛋还有什么类似菜谱”场景，引出图检索 + LLM 结合的必要性。
2. **架构概览**：引用“总体原理”示意图，说明 GraphRAG 方案如何串联数据 → 图 → 生成。
3. **数据处理亮点**：强调 Markdown 多别名解析、示例数据兜底与 `--limit` 控制量级。
4. **GraphRAG 细节**：讲述 `RecipeGraphBuilder` 相似度公式、`max_neighbors` 策略与向量回退逻辑，让听众理解“检索 + 生成”互补关系。
5. **LLM Prompt**：展示 `LLMGenerator.build_prompt()` 片段，说明如何将参考菜谱与候选菜谱拼接成上下文。
6. **CLI 实机演示**：现场运行 `uv run scripts/run_pipeline.py U123`，展示输出并说明解释文本来自 LLM/模板。
7. **规划与风险**：以第 8 节为剧本，提出后续迭代方向（新增多语言、图可视化、用户反馈闭环等）。

> 以上技术方案报告可直接用于 PPT 章节：背景 → 架构 → 流程 → 运行方式 → 风险/规划。
